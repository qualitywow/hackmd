# 無線感測網路協定與應用

## 評分項目
- 30% 期中考
- 15% 論文報告
- 30% 實驗
- 10% 出席
- 15% 作業

## 期中考範圍
- Open:
  - [x] Bluetooth [⭐️](bluetooth_spec_10.7)
  - [ ] SDN+Data center congestion control
  - [ ] Coverage
  - [ ] Sensor network
  - [ ] Naming
  - [x] Power control on satellite
- Precise:
  - [x] Bluetooth mechanism [⭐️](http://www.tsnien.idv.tw/Network_WebBook/chap16/16-6%20%E5%9F%BA%E9%A0%BB%E9%80%9A%E9%81%93%E6%8E%A7%E5%88%B6.html)
  - [ ] Power control
  - [ ] Topology control

## 5G Power Control Abstract
[Efficient Transmission Power Control for Energy-harvesting Cognitive Radio Sensor Network](https://ieeexplore.ieee.org/document/8880825)  
> 無線感測科技的快速發展促升許多有趣的應用。由於感測器的續航力低，energy harvesting(能源獲取)是延續感測器節點生命的必要措施。本文為感知無線電中的感測器網路(energy harvesting cognitive radio sensor network, EH-CRSN)設計一個分散式的傳輸能源控制機制。主要的概念是基於維持網路連接性(network connectivity)的網路狀態去動態調整節點的傳輸功率。由多個參數，(如：可用電量、鄰近節點電量等)決定每個節點的功率要打大打小。這種動態傳輸功率調整可轉換成網路邏輯拓樸，能更容易適應網路的耗能狀況。作者在兩種情境下測試傳輸功率控制的機制：扁平網路(flat network)及叢集網路(cluster network)，延伸的模擬結果顯示，使用傳輸功率控制方法後，可以改進網路中端對端(end-to-end)傳輸的效能。

[Sensing-Based Power Adaptation for Cellular V2X Mode 4](https://ieeexplore.ieee.org/document/8610405)  
> 最近3GPP推出了蜂巢式車輛對其他設備(cellular vehicle-to-everything, C-V2X)的標準來支持車輛對其他設備(V2X)的傳輸。在C-V2X中，無線電資源可以透過中心網路或分散式網路來控制(Mode 4)。在Mode 4中，每個車輛可以選擇自己用來傳輸V2X訊息的資源，不需要蜂窩網路的支援。作者透過模擬研究並討論了在Mode 4中不同車輛密度對於傳輸功率的影響。基於討論的結果，作者提出一個自適應的功率控制演算法，車輛能使用即時的通道感測資訊作為功率控制的依據，實驗結果證明作者的演算法優於傳統的做法。

[Adaptive power control for mutual interference avoidance in industrial internet-of-things](https://ieeexplore.ieee.org/document/7560884)  
> 隨著IoT和5G科技的蓬勃發展，像是M2M、D2D等，包括環境監測、設備控制等各種資料傳輸等都使無線感測網路在大型無線通訊系統中的重要性加大。然而，特別是在複雜的工業無線應用中，有限的無線電資源加劇了異質網路間共存的問題。在本文中，從嚴重互相干擾的角度出發，描述了有關工業無線感測網路中累績干擾的數學模型。接著，叢避免互相干擾的角度出發，提出一種自適應的功率控制方法，來主要鏈路(primary link)與次要鏈路(secondary link)中的一般通訊需求。最後，使用非線性的程式來解決對應的最佳化問題。作者給出一些典型的分析來驗證方法在最佳化系統效能與能量消耗的權衡間的有效性。作者也分析了在工業物聯網下此方法的能源效率，結果顯示能在避免互相干擾的前提下，提高吞吐量並降低耗能。

## Topology Control
網路中節點很密集時，會產生(1)過多碰撞(2)過多MAC protocol複雜操作(3)Routing protocol有太多條路可以選。
解法(1)降低/控制power來讓路變少(2)決定哪些link要留著用(3)把一些node關掉。
### Tree Topology
![Image](https://i.imgur.com/T0e9UMv.png)
建樹狀結構可以使重傳次數降低，使網路life-time增加。
怎麼選其中的relay node就是很重要的問題，常用spanning tree來解。建spanning tree可以減少傳輸的hop數，進而降低耗電。
有集中式、分散式兩種，集中式由root開始BFS，分散式的worst case可能走成DFS，讓傳輸所需的hop數過多。分散式較難，後面討論。
![Image](https://i.imgur.com/WEE3ocT.png)
### Design and Analysis of an MST-Based Topology Control Algorithm


## Power Control
影響參數非常多，e.g. 干擾、連通性、電量、空間利用度、BER
power control 好處：
- Improve network throughput, transmission range, fairness, connectivity
- Reduce overall energy consumption, packet latency, interference and energy consumption
- Neighbor discover
- Power control helps in scheduling 
- Partial combination of above targets
---
### Topology Control of Multihop Wireless Networks using Transmit Power Adjustment
本篇針對拓樸中可控制的參數有(1)傳輸功率(2)天線方向，建立一個好的網路拓樸
#### Static Networks: Min-Max Power Alg.
**Connected**
1. 為達成網路的連接性，將網路中的節點看成圖論中的點，每個點有各自的傳輸功率，兩節點能溝通所需的power為邊的權重，找出min weight spanning tree。
2. 因為有些邊(side-effect-edge)雖然不是在第一步時選到的邊，但節點的兩端卻可以通訊。此時可以試著降低剛剛選的節點所打的power，在滿足連通性的情況下，斷掉一些不必要的邊。

**Bi-Connected**
1. 和Connected一樣先找min weight spanning tree，依序檢查加入weight最小的邊，直到圖變成Bi-Connected。
2. 檢查有無side-effect-edge，有的話試著降低打的power，斷掉非必要的邊。

#### Mobile Networks: Distributed Heuristic Algorithms
- 因為網路拓樸不斷變化，須不斷調整power
- 要取得global information overhead太高，故每個節點只有local information
由此提出兩個distributed heuristic演算法
1. **LINT (Local Information No Topology)**
    :dart: 所有節點保持可與一定數量的鄰居通訊(degree)。
    每隔一段時間檢查自己的degree是否在規範的threshold之中，再依照目前的degree來調整功率大小。
    調整的方式就去算path loss，節點可成功傳輸的power - path loss = 接收者可成功接收資料的最小訊號強度。
    :x: 對網路的連接性較不小心、可能造成網路partitioning
2. LILT (Local Information Link-state Topology)
    :dart: 改善LINT可能造成network partitioning的缺點
    由routing protocol所獲得的flobal connectivity inforamtion判斷是否有partition可能發生，進而修補。
    LILT可分為兩部分
    - Neighbor reduction protocol(NRP)
        - 和LINT機制相同，使每個節點保持所要的degree數
    - Neighbor addition protocol(NAP)
        - 用來修補network partition的機制
        - disconnected: 當節點各自隨機移動，且發現溝通完全溝通不到其它節點，將power打到最大。
        - not bi-connected: 先等一段時間，說不定等等的移動就會形成bi-connected。等一段時間還是沒有bi-connected就打到最大。



## Uplink Power Control at SAT
:question: Bent-pipe衛星(只能當放大器)，要怎麼做Power Control？  

### Background
Uplink Power Control(ULPC) SAT是透過SAT生成的feedback signal做close loop power control。
收到Satellite Terminal(ST)傳來的訊號後，SAT會生成 (1)feedback (2)beacon，並DL回給ST。

- open loop power control：SAT不用回feedback給STs
- close loop power control
    - bent-pipe SAT：不做on-board processing，要透過ST-SAT-ST形成的loop來做power control。
    - on-board SAT

Ka band傳輸易受雨衰、雲遮蔽等干擾，故需一種考慮大氣摔落、外部干擾、傳輸延遲等狀況的ULPC system，使ST UL到SAT端可維持期望的訊號品質。

### ULPC at SAT
- 目標：在STs上執行ULPC ALG，來調整要打在每個載波頻率的訊號強度，自動做出相對於其他ST的調整。
- 輸入：從SAT收到的feedback information。
- 假設：SAT可量測ST-SAT的UL SNR、SINR，生成CSI data。
- 想法：
    1. SAT要gen一個power beacon(per 3ms)，Cell要定期傳給STs(per 96ms)。
    2. 每個ST要推導和power beacon有關的CarrierFrequency-to-Noise data，用來估計DL fading、促進ST傳輸功率的調整。
    3. 用SAT feedback info維護filter tables
        - ST溫度變化
        - SAT增益變化
        - UL頻譜形狀變化
        - fading估計

- Goal
    1. 保證在大氣摔落、干擾下，仍有足夠的link margin。(e.g. Packet loss rate < threshold)
    2. 補償ST和SAT Radio Frequency的缺陷。(e.g 傳輸功率隨頻率、時間變化而變化)

## Bluetooth
### Part A: Radio Specification
- Key features: 傳輸強健(robustness)、低複雜度、低功耗、低成本。
- 用frequency hopping來抗干擾(interference)、衰落(fading)。
- 跑在unlicensed ISM band，2.4 GHz(240.00 ~ 248.35 MHz)。
- 一個slot長度原則上是625 μs。
- 走全雙工(full duplex)，可以同時收送，用分時(TDD)的方法執行。
- 一個封包原則上用1個slot傳，但也可以加到最多5個來傳。
---
- Bluetooth protocol是circuit switching和packet switching的混合。
- slot可以為同步(sync)封包傳輸保留。
- Bluetooth可以支援一個async channel、最多可以同時跑3個sync voice channel，或同時跑一個async data和一個sync voice的channel。

#### Power Control
|Power Class|Maximum Output Power|Minimum Output Power|
|-|-|-|
|**1**|**20 dBm**|**0 dBm**|
|2|4 dBm|-6 dBm|
|3|0 dBm|N/A|

- class 1 device transmit power要大於0 dBm。
- 0 dBm以下的power control是非必要的，可用來最佳化(1)能量消耗(2)整體的干擾程度。
- 調整power大小的power step要是個單調序列，一個step最多調8 dB，最少調2 dB。
---
- 透過測量RSSI並回報power要打大打小，可以最佳化output power。
    - RSSI測量將RSSI與兩個threshold進行比較，這兩個threshold定義了黃金接收功率範圍。
    - 較低的threshold對應於接收器實際靈敏度以上-56 dBm至6 dB之間的接收功率。
    - 上限threshold比下限threshold高20 dB，精度為+/- 6 dB。
- 若Rx不支援Tx用來做power control的訊息，那class 1裝置就無法向此Rx發送封包。
- class 1 device若對一個靠得很近的device做paging或inquiring，可能因為打的power過大導致對方無法回覆訊息，此時用class 2/3傳輸也很有用。
### Part B: Baseband Specification
- Bluetooth支援p2p、p2m傳輸
- p2m傳輸，會有多個裝置共享一個channel
    - 2個以上的裝置共享同一個channel，即形成一個piconet。
    - 有重疊coverage的多個piconet就形成一個scatternet。
    - 其中會有一個裝置作為master，其他則為slave(s)。
    - 一個piconet最多可以同時active 7個slaves。
    - 一個piconet只能有一個master，但slaves可以透過分時的方式參與多的piconet。
    - 一個piconet的master可以當其他piconet的slave。
    - piconets的頻率不能同步，每個piconet有自己跳的channel。

![Image](https://i.imgur.com/EEafkMT.png)

#### Physical Channel

##### Channel Definition
- 有79/23個Radio Frequency(RF) channel可以做跳頻(pseudo-random hopping)。
- 每個piconet的跳頻序列(hopping sequence)是唯一的，由piconet master的Bluetooth address決定。
- 跳頻序列中的phase由piconet master的Bluetooth colck決定。
- channel會切成幾個time slots，每個time slot對應一個RF hop frequency。
- 原則上跳頻速度是1600 hops/s。所有piconet中的所有Bluetooth units都是時間同步、跳頻同步的。

##### time slots
- 1 slot = 625 μs。
- time slots的編號由piconet master的Bluetooth colck排，範圍在0~227-1。
- master/slaves分時傳(e.g. 偶數slot master送，奇數slot slaves送)。
![Image](https://i.imgur.com/ODfaMNe.png)
- 封包開始傳的時間要和time slot開始的時間切齊。(Sync)
- 封包如果1個slot傳不完，最多可以延長到5個slots。
![Image](https://i.imgur.com/Chx76pD.png)

:anchor:只允許連續k個slot，不能佔太久，為何？若是為符合公平性，那比例應該如何調？
:pencil2: 感覺沒提到什麼公平性。但封包的設計分送1/3/5個time slot三種，傳的payload長度最多傳5個time slot可傳完。
> 連續傳送時槽可減少每一封包的封包標頭，如果每次都只能用一個時槽傳送，每一封包填入時槽時，都必須加入許多控制訊息。
> 但由於 Master 和 Slave 各被限制只能固定於偶數或奇數時槽傳送，因此，連續時槽僅能為 1 個、3 個或 5 個，否則會跨越到對方（Master 跨到 Slave 或 Slave 跨到 Master）的起始傳送時槽。
#### Physical Links
master/slaves間可以建立不同類型的link，有以下兩種：
- Sync Connection-Oriented(SCO) Link
    - point-to-point(p2p)，一個master對一個slave。
    - master會用預訂好的time slot來maintain SCO link。可以想成是circuit switched的樣子。
    - 用來傳輸具time-bouned的資料，e.g. voice。
    - master最多可以建3條SCO links，對同一個slave或不同slave都可以。
    - SCO link永不重送，master會用regular interval送SCO packet。(...)
    - master送封包給slave後的那一個slot，允許slave回SCO封包給master。(...)
    - 如果SCO slave無法解開packet hearder中的slave address，那slave仍然可以在排好的SCO slot中回一個SCO packet。(告訴master說自己解不開？)
    - SCO link的建立是master發一個SCO setup msg給slave。msg中會包含指定reserved slot的資訊。
    - slave最多可以和同一個master建3個SCO links。如果有身上有和其他mater建的link，也可以建2個。
- Async Connection-Less(ACL) Link
    - point-to-multipoint(p2m)，一個master對全部的slaves。
    - master可以分不同的slot去和任一slave建立ACL link，已經建立SCO link的slave也可以。不會使用預訂的time slot。
    - ACL link提供master和piconet中所有slave間packet-switched的連線。
    - 一個master只能和一個slave建一個ACL link。
    - 大多數的封包會為了保證資料完整性而有重傳的動作。
    - slave只有在master有在master-to-slave slot指名說要他回ACL封包，slave才能在下一個slave-to-master slot回ACL封包。(...)

#### General Format
- bit照Little Endian表示，the least significant bit(LSB)會對應$b_0$的bit，
- LSB是最早傳出去的bit，一般LSB會寫在左邊。
- 每個封包都長得像下圖，有access code/header/payload三段。
![Image](https://i.imgur.com/YZMwW1p.png)
    - access code
        - 每個piconet的access code都相同，有preamble/sync word/trailer(可有可無)
        ![Image](https://i.imgur.com/bkGe574.png)
    - header
        - AM_ADDR: 3- bit active member address
        - TYPE: 4-bit type code
        - FLOW: 1-bit flow control
        - ARQN: 1-bit acknowledge indication
        - SEQN: 1-bit sequence number
        - HEC: 8-bit header error check
        ![Image](https://i.imgur.com/Ho46fvP.png)
##### Commom Packet
- ID packet: 帶有ID or device access code (DAC) or inquiry access code (IAC)。
- NULL packet: 帶channel access code, packet header。回應先前傳輸成功的訊息(ARQN) or  RX buffer狀態的link info給TX。
- POLL packet: piconet中的master用來polling slave的封包，不管slave有沒有要送訊息，都要回這個封包。
- FHS packet: 一種特殊的控制封包，用來paging master的回應等。(...)
    - 每次重送前，這個colck info會更新
    - FHS packet用來在piconet channel建立前做frequency hopping的同步，或在一個已存在的piconet中產生一個新的piconet
- SCO packet:
    - HV packet: 傳語音的封包(High quality Voice)
    - DV packet: 傳資料、語音的封包
- ACL packet:
    - DM1 packet: 只帶資料的封包
    - DH1 packet: 只帶資料的封包，但沒有做FEC編碼
    - AUX1 packet: 重組DH1，但沒有放CRC檢查碼
- ARQ SCHEME: 
    - 自動重複請求DM/DH/DV等封包，直到收到RX給的確認收到訊息(或直到timeout)為止。
    - 確認訊息換在return packet的header裡，也就是piggy-back。


## Discover device nearby
- Device State
    - Standby State
        - Inquiry: 送Inquiry封包時
        - Inquiry Scan: 聽或回其它device廣播來的封包時
        - Page: 傳封包時
        - Page Scan: 聽或回給自己的封包時
    - Response State: master/slave交換建立連線封包時
    - Connection State: master/slave建立連線之後

每個藍芽裝置都有一個unique 48-bit MAC address，24-bit為company_id，24-bit為company_assigned。

### new :anchor⚓️:
一個藍芽設備可以有兩種類型的address
- Public Device Address: 出廠就決定，IEEE會負責確保唯一性
- Random Device Address: 裝置啟動才隨機生成的
    - Static Device Address
    - Private Device Address
        - Non-resolvable Private Address
        - Resolvable Private Address
